import { useState, useEffect } from 'react';
import dayjs from 'dayjs';
import CalendarMonthControl from '@/components/calendar/CalendarMonthControl';
import Calendar from '@/components/calendar/Calendar';
import TimeSlots from '@/components/time/TimeSlots';
import { formatKoreanDate } from '@/utils/dateTime';
import * as S from './steps.styles';

export default function StepDateTime({ initialData, onChange }) {
  const [selectedDate, setSelectedDate] = useState(initialData.date); //선택된 날짜
  const [selectedTime, setSelectedTime] = useState(initialData.time); //선택된 시간
  //선택된 날짜의 month, 없다면 현재 달
  const [currentMonth, setCurrentMonth] = useState(selectedDate ? dayjs(selectedDate) : dayjs());

  //이전 달 이동 헨들러
  const goPrevMonth = () => {
    //이전 달 이동 금지
    setCurrentMonth((m) => (m.isSame(dayjs(), 'month') ? m : m.subtract(1, 'month')));
    //달 이동시 선택 날짜, 시간 초기화
    setSelectedDate(null);
    setSelectedTime(null);
  };

  //다음 달 이동 헨들러
  const goNextMonth = () => {
    setCurrentMonth((m) => m.add(1, 'month'));
    //달 이동시 선택 날짜, 시간 초기화
    setSelectedDate(null);
    setSelectedTime(null);
  };

  //다음 단계 진행 여부
  const isValid = Boolean(selectedDate && selectedTime);

  useEffect(() => {
    onChange({
      date: selectedDate,
      time: selectedTime,
      isValid,
    });
  }, [selectedDate, selectedTime, isValid, onChange]);

  return (
    <>
      <S.SectionHeader>
        <S.SectionTitle>날짜 선택</S.SectionTitle>

        <CalendarMonthControl
          currentMonth={currentMonth}
          onPrev={goPrevMonth}
          onNext={goNextMonth}
        />
      </S.SectionHeader>

      <Calendar value={selectedDate} currentMonth={currentMonth} onSelect={setSelectedDate} />
      <S.SectionTitle>
        시간 선택
        {selectedDate && <S.SelectedDateText>{formatKoreanDate(selectedDate)}</S.SelectedDateText>}
      </S.SectionTitle>

      <TimeSlots date={selectedDate} value={selectedTime} onSelect={setSelectedTime} />
    </>
  );
}
